\chapter{Model and methods}
\label{chap:modmet}
\section{Modeling System description}
\label{sec:modeldes}
%(What did Johanne and Kjetil and Linda Bjørn Egil think was important enough to write about in their thesees?)

To produce results for the thesis, a formulation of the Weather Research and Forecasting (WRF) Model called the Advanced Research WRF (ARW) has been used, Version 3.6.1, released in April 2014. The model is developed at the National Centre for Atmospheric Research (NCAR) in Boulder, Colorado. The ARW model is the first fully compressible conservative form nonhydrostatic model designed for both research and operational numerical weather prediction (NWP) applications~\citep{Skamarock2008}. 

As can be seen from figure~\ref{fig:wrfflowchart} the WRF Modeling System consists of four major programs~\citep{Wang2015}:
\begin{itemize}
\item The WRF Prepocessing System (WPS)
\item WRF-Data Assimilation (WRF-DA)
\item ARW solver
\item Post-processing \& Visualization tools
\end{itemize}

WPS is used primarily for real data simulations~\citep{Wang2015}, like the study presented in this thesis. Its functions include defining simulation domains, interpolating terrestrial data and degribbing and interpolating meteorological data from another model to this simulation domain~\citep{Wang2015}. WRF-DA is optional and can be used to ingest observations into the interpolated analyses created by WPS~\citep{Wang2015}, but was not used in this study. The ARW solver is the key component of the modeling system, which is composed of several intialization programs for idealized, and real-data simulations, and the numerical integration program~\citep{Wang2015}. Fully compressible nonhydrostatic equations with hydrostatic options, regional and global applications, complete coriolis and curvature terms and that vertical grid-spacing can vary with height are among the WRF models key features according to~\cite{Wang2015}.

\begin{figure}
\centering
\includegraphics[width=\textwidth]{model_methods/wrfflowchart}
\caption{Flowchart for the WRF ARW Modeling System Version 3. From~\cite{Wang2015}.}
\label{fig:wrfflowchart}
\end{figure}

The model can be run for ideal cases or real cases. I have run the REAL-TIME WRF, real.exe — to produce inputfiles for wrf.exe.
%Any detailed information on the model, presented in this section is based on the Article by~\cite{Skamarock2008} unless otherwise stated.

The continuous equations solved in the ARW model are the Euler equations cast in a flux form where the vertical coordinate, $\eta$, is defined by a normalized hydrostatic pressure,
\begin{equation}
\eta = (p_h - p_{ht})/\mju 
\end{equation}
where $\mju = (p_{hs} - p_{ht})$~\citep{Skamarock2008}. $p_h$ is the hydrostatic component of the pressure and $p_{hs}$ and $p_{ht}$ are the values of the hydrostatic pressure in a dry atmosphere at the surface and top boundaries respectively~\citep{Skamarock2008}.

The vertical coordinate is the traditional $\sigma$ coordinate used in many hydrostatic atmospheric models, shown in a diagram in figure~\ref{fig:sigma}.

\begin{figure}
\centering
\includegraphics[scale=1]{model_methods/sigma.pdf}
\caption{This figure is shown as presented in~\cite{Skamarock2008}, and is a schematic of the terrain following a $\sigma$ coordinate. $P_{hs}$ and $P_{ht}$ is the hydrostatic pressure at the surface and the top respectively.}
\label{fig:sigma}
\end{figure}

\subsection{Physics, radiation and interactions in WRF}
Based on the WRF-ARW Version 3 User's Guide by~\cite{Wang2015}.
%Based on the description of ARW Version 3 from \cite{Skamarock2008a}. 
The physics options in WRF fall into several categories, each containing several choices. Table~\ref{tab:physics} shows the different categories and the choice of scheme within each category.

\begin{table}[H]
\centering
\caption{Table of physics categories and choice of scheme for this thesis}
\label{tab:physics} 
\begin{tabular}{L{6.cm} L{6.cm}}
\centering
\textbf{Physics categories} & \textbf{Scheme selected within category}\\ \hline
(1) microphysics & aerorol-aware ~\citep{Reisner1998},~\citep{Thompson2004},~\citep{Thompson2008}~\citep{Thompson2014} \\
(2) cumulus parameterization & Grell 3D  nr5 @cite authors \\
(3) planetary boundary layer (PBL) &  Yonsei University scheme nr1 @cite authors\\
(4) land-surface model & Noah Land Surface Model nr2 @cite authors\\
(5) radiation & RRTMG LW \& SW nr4 @cite authors\\
\end{tabular}
\end{table}

The microphysics includes explicitly resolved water vapor, cloud, and precipitation processes. The aerosol-aware scheme was chosen to avoid the use of WRF-Chem, but to still have scavenging of aerosols and have proper enough representation of aerosols to study aerosol-cloud interactions.

The choice of cumulus parameterization was based on the grid resolution, and the best fit for it. A horisontal grid spacing of 4~km can be fine enough to not use cumulus parameterization, but in this thesis I chose a parameterization that was more suitable for grid sizes less than 10~km, the Grell 3D parameterization. (Grell 3D an improved Multi-closure, multi-parameter ensamble method with typically 144 sub-grid members, that may be used on high resolution (like mine)) 

(Yonsei University scheme. Non-local-K scheme with explicit entrainment layer and parabolic profile in unstable mixed layer.)

The land-surface model choice came to Noah Land Surface Model, which provides sensible and latent heat fluxes to the PBL scheme. Additionally, it predicts soil ice, and fractional snow cover effects, which could be important in the Arctic, but it is probably not the most important choice, since there is very little land in the area investigated, figure~\ref{fig:area}. (Noah Land Surface Model: Unified NCEP/NCAR/AFWA scheme with soil temperature and moisture in four layers, fractional snow cover and frozen soil physics.)

The radiation schemes were chosen simply because they are the best match for the microphysics scheme at the time of writing. According to~\cite{Thompson2014} the RRTMG schemes for SW and LW are the only radiation schemes which include the effects of the effective radii calculated in aerosol-aware. (RRTMG LW: An accurate scheme using look-up tables for efficiency. Accounts for multiple bands and microphysics species, and includes the MCICA method of random cloud overlap. Major trace gases are constant in my runs, and their values are $CO_2=379e-6$, $N_2O=319e-9$, $CH_4=1774e-9$. nr4 @cite authors)

\section{Schemes}
\label{sec:schemes}
The ARW model offers a wide selection of schemes to treat different physics that one wants represented in the model. The schemes treat the physics slightly differently and some schemes are better for certain horisontal and vertical resolutions than others, so one needs to be careful when choosing how the model is to treat the physics. For my thesis, the especially relevant scheme to mention is the cloud microphysics scheme that I chose, which is the aerosol-aware scheme described in~\cite{Thompson2014} which is a development of the bulk microphysisc scheme described in~\cite{Thompson2008}, to include aerosols and scavenging of them. The scheme is a true double moment scheme and therefore treats cloud water, cloud ice, rain and snow in a complex and detailed way(@???litt vagt og rart å skrive)~\cite{Thompson2014}. At the time of writing, the only radiation schemes that make use of the effective radii are the Rapid Radiative Tranfer Model (RRTM) for General Circulation Models (GCMs) (RRTMG) radiation schemes~\cite{@authorsRRTMG} for both SW and LW. These were therefore used in combination with the aerosol-aware cloud microphysics scheme.

\subsection{The aerosol-aware scheme}
According to the ARW User's Guide by~\cite{Wang2015}, the aerosol-aware scheme considers water- and ice-friendly aerosols, and a climatological dataset may be used to specify initial and boundary conditions for the aerosol variables. I have used this climatological dataset, which is explained in Section~\ref{sec:inputdata}~Input~data.
The microphysics option 28, the aerosol-aware scheme~\citep{Thompson2014} is built on the schematic shown in figure~\ref{fig:microphysics}, from~\cite{Reisner1998}. It is a double moment scheme, which means it computes both mixing ratios and number concentrations for the same water species (hydrometeors). 

\begin{figure}
\centering
\includegraphics[scale=0.8]{model_methods/microphysics.pdf}
\caption{Cloud microphysical parameterization scheme typically used i NWP models as shown in~\cite{Reisner1998}. A full list of the acronyms used in the schematic can be found in~\cite{Reisner1998}.}
\label{fig:microphysics}
\end{figure}

FIgure~\ref{fig:microphysics} is the basis for modeling cloud microphysical processes. The aerosol-aware scheme is an extension of the Thompson bulk microphysics scheme which was originally built on this~\citep{Thompson2004}, but there is not much left of it in the code now (@cite the code comments?).

\subsection{The RRTMG radiation schemes}
Icano et al. 2000?

\section{Model setup}
\label{sec:modelsetup}
@Area description. Sea names: Beaufort and ??. By Canada and Alaska, this is because data from the area has been used for research by others @citations. The area is not ice free any part of the year @cite, and provides a good place to simulate cloud and sea ice interaction. Approximately 7 hours behind UTC time, the times given in the WRF ARW modeling system are UTC. This means that figures showing 1200 UTC are for approximately 0500 in the morning local time in Canada and Alaska.
\\
I ran ARW with a horisontal resolution of 4 km, and 72 vertical layers. This resolution is sufficient to resolve clouds @citation. 300$\cdot$ 300 gridpoints, with 4 km spacing, between .
\\
I call the vertical layers in the ARW model eta levels, because of the choice of $\eta$ as the vertical coordinate. These levels have uneven vertical spacing. Since the level height is dependent on pressure, the height varies in both time and space. Consequently the levels in the lower troposphere are closer to each other than higher up in the troposphere. Therefore the low clouds in the area can be resolved. (@How close? what heights??)
\\
The sea ice in the area was removed by editing the input file constructed? built? by WPS and real.exe, to get results to compare with results from runs with ice.
\\
From diminishing sea ice we might experience an increase in sea traffic, which would lead to an increase in aerosol content in otherwise clean air @citation. To include increase in aerosol concentrations due to lack of sea ice I used the microphysics scheme developed by Greg Thompson and Trude Eidhammer described in~\cite{Thompson2014}.
\\
The scheme uses a monthly mean for aerosol number concentrations derived from multi-year (2001-2007) global model simulations @citationColarco2010??(det har de cita) in which particles and their precursors are emitted by natural and anthropogenic sources and are explicitly modeled with multiple size bins for multiple species of aerosols by the Goddard Chemistry Aerosol Radiation and Transport (GOCART) model (@desiterteGinoux2001)~\citep{Thompson2014}.
\\
Choice of schemes and reasons should be presented. As should how WPS and real.exe and wrf.exe works. At least short about what they do and contribute with to get to the end results. Explain some of the improvements in the micro physics scheme in combination with the revised radiation schemes (RRTMG for SW and LW).

\section{Model runs}
\begin{table}[H]
\centering
\caption{Table showing the name of the runs and what is included}
%Caption could say: Table showing the names of the runs and if they have sea ice or not, and if the aerosol concentration has been increased. All the runs have the same horisontal resolution of 4kmx4km, dimensons 300x300, vertical layers 72 and time step 24 s.
\label{tab:runs} 
\begin{tabular}{L{2.3cm} L{2.3cm} L{2cm} L{1.5cm} L{1cm} L{1cm} L{3cm}}
\centering
Name & Horisontal resolution & Dimensions & Vertical layers & $\Delta$t & Sea ice & Aerosol concentration\\ \hline
control & 4~km x 4~km & 300 x 300 & 72& 24~s & yes & control\\
NoIce & 4~km x 4~km & 300 x 300 & 72 & 24~s & no & control\\
Aero10 & 4~km x 4~km & 300 x 300 & 72 & 24~s & yes & control x 10\\
Aero10NoIce & 4~km x 4~km & 300 x 300 & 72 & 24~s & no & control x 10\\
Aero100 & 4~km x 4~km & 300 x 300 & 72 & 24~s & yes & control x 100\\
Aero100NoIce & 4~km x 4~km & 300 x 300 & 72 & 24~s & no & control x 100 \\
\end{tabular}
\end{table}

Which table?

\begin{table}[H]
\centering
\caption{Caption could say: Table showing the names of the runs and if they have sea ice or not, and if the aerosol concentration has been increased by a factor of 10 or 100 through input files. All the runs have the same horisontal resolution of 4kmx4km, dimensons 300x300, vertical layers 72 and time step 24 s.}
\label{tab:runs} 
\begin{tabular}{L{2.3cm} L{2cm} L{3cm}}
\centering
Name & Sea ice & Aerosol concentration\\ \hline
control & initial & control \\
NoIce & removed & control \\
Aero10 & initial & control x 10 \\
Aero10NoIce & removed & control x 10 \\
Aero100 & initial & control x 100 \\
Aero100NoIce & removed & control x 100 \\
\end{tabular}
\end{table}

\subsection{Manipulation of input files}
wrfinput\_d01 and wrfbdy\_d01 are input files for domain 1, in my case the only domain, and are made by real.exe. These files are then used as initialization or forcing when wrf.exe is run.
To run the model without ice and with an increased number of aerosols I manipulated the input files for WRF. I used a netCDF Operator (NCO) tool, ncap2. This allowed me do manipulate the netCDF files from my terminal window in the folder where they were located.
Elaborate on removal or placing of sea ice. Elaborate on multiplying the aerosol number concentration with a factor 10 or 100. By use of ncap2 from NetCDF (NCO).

\subsection{Changed ice run}
The sea ice variable in the wrfinput\_d01 file was simply multiplied by 0 in every gridpoint and by that removed.
Removed ice from the input file for the model run by using NCO and ncap2. The point of this is to compare the run with no ice to the control run, and see if there are any changes to the cloud properties.

\subsection{Changed aerosols run}
The increase in aerosol concentration was a bit more complicated, but the same method. The number of water and ice friendly aerosols were multiplied by 100 and so were their tendencies and respective concentrations at the boundaries of the area. %wrfbdy is a lateral boundary file, contains the WRF lateral boundary conditions~\citep{Wang2015}.
The goal is to find changes in cloud properties compared to those in the control run, for that purpose the aerosol concentration was multiplied by a factor of 100. Hoping to get a signal. \textbf{This has not worked yet, since the input variables had 0 as input value for aerosol number concentrations....!}

\section{Input data}
\label{sec:inputdata}
The model runs were initialized with data downloaded from the European Centre for Medium-Range Weather Forecasts (ECMWF).%was downloaded from their site and used as input for initial and boundary?? conditions.
The downloaded data is from the ERA-Interim dataset, which is a global atmospheric reanalysis from 1979 to present and continues to be updated in real time.%~\cite{ecmwf}.@make bib for ecmwf
Through WPS the data from ERA-Interim was interpolated over the area, with a 2 degree minute spacing between the points, to be used to initialize the model. The data used is in 6-hourly atmospheric fields on pressure levels, for the first five days of September 2012, which was the period the model was run for. This is done to make sure the initial meteorological conditions are the same in every run, so that the effects of changing a variable in the input files for the modeling system are only due to that change.

%Explain the use of climatological data for aerosol input.
To use the cimatological aerosol dataset, the file containing monthly means had to be called through WPS for real.exe to make input data for water- and ice-friendly aerosols in the wrfinput\_d01 and wrfbdy\_01 files.

\section{Processing of the results}
Figures presented in my thesis, I made (unless other is stated) by use of National Centre for Atmospheric Research (NCAR) Command Language (NCL) and MatLab. For the NCL scripts I found a lot of help and inspiration from the example scripts for WRF-users available at (URL for examples).

I made all the figures that are over maps with NCL, the others were made with MatLab provided by the University.

MathWorks, it is very useful and easy to use.

NCL it is free and there are a lot of available example scripts to quickly learn how to use the graphics.